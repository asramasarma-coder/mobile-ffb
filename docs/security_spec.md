# Security & Authentication Specification
**Version:** 1.0  
**Status:** Draft  
**Date:** February 2026  

---

## Overview

This document defines the authentication flow, authorisation model, data security controls, and security policies for the AgriField platform.

---

## 1. Authentication Flow

### 1.1 SSO via Firebase Auth (OIDC)

```
Mobile App
    ↓
Redirect to Company SSO Provider
(Microsoft Entra / Google Workspace / Okta)
    ↓
User authenticates with company credentials
    ↓
SSO Provider issues OIDC token → Firebase Auth
    ↓
Firebase Auth issues Firebase JWT
    ↓
App stores JWT in Expo SecureStore
    ↓
JWT attached to every API request:
Authorization: Bearer <firebase_jwt>
    ↓
Cloud Run validates JWT on every request
(Firebase Admin SDK — no custom key management)
    ↓
User identity + role extracted from token claims
    ↓
Request processed with role-based access
```

### 1.2 Token Management

| Property | Value |
|---|---|
| Token type | Firebase JWT (RS256) |
| Token lifetime | 1 hour |
| Refresh | Firebase SDK handles refresh automatically |
| Storage (mobile) | Expo SecureStore (iOS Keychain / Android Keystore) |
| Token rotation | On every refresh (automatic) |
| Revocation | Via Firebase Admin — deactivate user to invalidate all tokens |

### 1.3 First Login Flow

```
User opens app for first time
    ↓
SSO login completes → Firebase JWT issued
    ↓
App calls GET /users/me
    ↓
If user not found in platform DB:
    → Create user record with status: 'pending'
    → Return 403 with code: PENDING_ACTIVATION
    → App shows: "Your account is pending activation by an admin"
    ↓
Super Admin activates user and assigns role in web dashboard
    ↓
Next GET /users/me returns active user with role
    ↓
App routes to correct home screen
```

---

## 2. Authorisation Model

### 2.1 Role-Based Access Control (RBAC)

Every API endpoint enforces role checks via middleware:

```javascript
// Middleware on every Cloud Run request
async function authMiddleware(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '')
  const decoded = await firebaseAdmin.auth().verifyIdToken(token)
  const user = await getUserFromDB(decoded.uid)

  if (!user || user.status !== 'active') {
    return res.status(403).json({ error: { code: 'FORBIDDEN' } })
  }

  req.user = user  // { id, role, assigned_region_id }
  next()
}
```

Role checks on routes:

```javascript
// Example: Admin-only endpoint
router.post('/approvals/:id/approve',
  requireRole(['admin', 'super_admin']),
  approveRegistration
)

// Example: Field assistant scoped to assigned farms
router.get('/farms/nearby',
  requireRole(['field_assistant', 'admin', 'super_admin']),
  getNearbyFarms  // filters by assigned_agent_id for field_assistant role
)
```

### 2.2 Data Scoping Rules

| Role | Data Scope |
|---|---|
| `super_admin` | All data in all regions |
| `admin` | All data in their assigned region |
| `field_assistant` | Only farms assigned to them (`assigned_agent_id = user.id`) |

Scoping is enforced server-side — it is not possible for a field assistant to access another agent's farms via API even with a valid token.

---

## 3. Data Security

### 3.1 Data in Transit

- All API traffic over HTTPS/TLS 1.2+ — enforced by GCP API Gateway
- Cloud Storage photo uploads via signed HTTPS URLs — TLS enforced
- Internal Cloud Run service-to-service communication via mTLS (GCP managed)
- No plain HTTP allowed — HTTP requests redirected to HTTPS

### 3.2 Data at Rest

| Storage | Encryption |
|---|---|
| Cloud SQL (PostgreSQL) | AES-256 at rest — GCP managed keys |
| Cloud Storage (photos) | AES-256 at rest — GCP managed keys |
| Mobile SQLite (WatermelonDB) | Unencrypted by default — SQLCipher optional for high-security deployments |
| Expo SecureStore (JWT) | iOS Keychain / Android Keystore — OS-level hardware encryption |

### 3.3 Photo Storage Security

- Photos stored in private Cloud Storage bucket — no public access
- Access via signed URLs only — generated by `api-core` with 60-minute expiry
- Raw upload bucket: `agrifield-photos-raw` — write-only for mobile, read for AI dispatcher
- Processed bucket: `agrifield-photos-processed` — read for admin dashboard only
- No direct bucket URL is ever exposed to the mobile app

### 3.4 Personally Identifiable Information (PII)

| Data | Classification | Stored Where |
|---|---|---|
| User name, email | PII | Cloud SQL `users` table |
| Farmer name, phone, national ID | PII | Cloud SQL `farmers` table |
| GPS coordinates (visits) | Operational | Cloud SQL `visits` table |
| Photos (crop/field) | Operational | Cloud Storage |

**PII access rules:**
- Farmer `national_id` is never returned in API list responses — only in single-record detail views
- Farmer PII is accessible to Admin and Super Admin only — not visible to field assistants via API
- User email is not exposed in any response other than `GET /users/me`

---

## 4. GCP Security Configuration

### 4.1 IAM Roles

| Service Account | Role | Purpose |
|---|---|---|
| `api-core-sa` | `cloudsql.client`, `storage.objectAdmin` | Core API service |
| `ai-dispatcher-sa` | `storage.objectViewer`, `cloudtasks.enqueuer` | AI dispatch service |
| `scheduler-sa` | `cloudsql.client` | Visit schedule generator |
| `notification-sa` | Firebase Admin SDK | Push notifications |
| `cloud-build-sa` | `run.admin`, `artifactregistry.writer` | CI/CD pipeline |

Principle of least privilege — each service account has only the permissions it needs.

### 4.2 VPC & Network Security

- All Cloud Run services deployed in a private VPC
- Cloud SQL accessible only within the VPC (no public IP)
- Cloud SQL Auth Proxy used for all database connections — no credentials in environment variables
- API Gateway is the only public ingress point
- Cloud Armor (WAF) enabled on API Gateway for DDoS protection

### 4.3 Secrets Management

- All secrets (Firebase credentials, API keys) stored in **Google Secret Manager**
- Cloud Run services access secrets via Secret Manager API — not environment variables
- Secrets rotated quarterly
- No secrets in source code or CI/CD logs

---

## 5. API Security

### 5.1 Rate Limiting

| Endpoint | Limit | Window |
|---|---|---|
| `POST /visits` | 100 requests | per user per hour |
| `POST /sync/push` | 10 requests | per user per hour |
| `GET /farms/nearby` | 300 requests | per user per hour |
| `POST /farms/register` | 20 requests | per user per day |
| All other endpoints | 500 requests | per user per hour |

Rate limits enforced at API Gateway level. Returns `429 Too Many Requests` when exceeded.

### 5.2 Input Validation

All request bodies validated server-side:
- JSON schema validation on every request body
- GPS coordinates validated as valid decimal values within plausible range
- File size and MIME type validated on photo upload confirmation
- All string fields sanitised — no raw SQL interpolation (parameterised queries only)
- `client_id` validated as valid UUID format

### 5.3 CORS Policy

```
Allowed origins:
  - https://*.agrifield.com (web dashboard)
  - capacitor://localhost (mobile app)
  - https://localhost (development)

Allowed methods: GET, POST, PATCH, DELETE
Allowed headers: Authorization, Content-Type
Max age: 3600
```

---

## 6. Mobile App Security

### 6.1 Secure Storage

| Data | Storage |
|---|---|
| Firebase JWT | Expo SecureStore |
| User preferences | AsyncStorage (non-sensitive) |
| Visit data (local) | WatermelonDB SQLite |
| Photos (local) | App-private filesystem (not accessible to other apps) |

### 6.2 Certificate Pinning

For production builds, implement SSL certificate pinning to prevent MITM attacks:
- Pin the API Gateway certificate
- Reject connections to pinned domains if certificate does not match
- Include a fallback pin to allow certificate rotation without forced app update

### 6.3 App Security Controls

- App requires device lock screen (PIN/biometric) to be enabled — enforced on first launch
- Auto-lock after 30 minutes of inactivity — user must re-authenticate via SSO
- No screenshot allowed on sensitive screens (approval detail, farm registration) — enforced via `FLAG_SECURE` on Android
- Deep links validated — only known `agrifield://` deep links accepted

---

## 7. Audit Logging

All significant actions are logged to **Cloud Logging** with the following structure:

```json
{
  "timestamp": "2026-02-23T10:30:00Z",
  "user_id": "uuid",
  "user_role": "admin",
  "action": "APPROVE_REGISTRATION",
  "resource_type": "farm",
  "resource_id": "uuid",
  "ip_address": "10.x.x.x",
  "result": "success"
}
```

**Logged actions:**
- Login and logout
- Farm/plant approval and rejection
- User role changes
- Master data create/edit/deactivate
- Visit submission
- Failed authentication attempts
- Rate limit exceeded events

Audit logs retained for 2 years in Cloud Logging with export to Cloud Storage for long-term archival.

---

## 8. Incident Response

| Severity | Examples | Response Time | Owner |
|---|---|---|---|
| Critical | Data breach, auth bypass | 1 hour | Engineering Lead |
| High | Service down, mass sync failure | 4 hours | Engineering |
| Medium | Partial feature outage | 24 hours | Engineering |
| Low | Individual user issue | 72 hours | Support |

**On suspected security incident:**
1. Isolate affected Cloud Run service
2. Revoke affected user tokens via Firebase Admin
3. Review audit logs for scope of incident
4. Notify affected users if PII involved
5. Post-incident review within 5 business days

---

*AgriField — Commodity Intelligence Platform | Confidential — Internal Use Only*