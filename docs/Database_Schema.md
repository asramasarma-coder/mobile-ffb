# Database Schema
**Version:** 1.0  
**Status:** Draft  
**Date:** February 2026  

---

## Overview

This document defines the server-side PostgreSQL schema (Cloud SQL) and the client-side WatermelonDB schema (mobile SQLite). Both schemas are designed to support offline-first operation with sync.

---

## 1. Server-Side Schema (PostgreSQL — Cloud SQL)

### 1.1 Conventions

- All primary keys are `UUID` generated by the server
- All tables include `created_at` and `updated_at` timestamps
- Soft deletes via `status` enum — no hard deletes on operational data
- Multilingual text fields stored as `JSONB` e.g. `{"en": "Oil Palm", "ms": "Kelapa Sawit"}`
- All foreign keys have explicit named constraints

---

### 1.2 Master Data Tables

#### `crop_types`

```sql
CREATE TABLE crop_types (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code                    VARCHAR(20) UNIQUE NOT NULL,
  name                    JSONB NOT NULL,              -- multilingual
  tracking_level          VARCHAR(10) NOT NULL         -- 'field' | 'plant'
                          CHECK (tracking_level IN ('field', 'plant')),
  is_seasonal             BOOLEAN NOT NULL DEFAULT false,
  typical_lifespan_years  INTEGER,
  icon                    VARCHAR(255),
  status                  VARCHAR(20) NOT NULL DEFAULT 'active'
                          CHECK (status IN ('active', 'inactive')),
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `visit_templates`

```sql
CREATE TABLE visit_templates (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crop_type_id    UUID NOT NULL REFERENCES crop_types(id),
  name            JSONB NOT NULL,
  version         INTEGER NOT NULL DEFAULT 1,
  status          VARCHAR(20) NOT NULL DEFAULT 'draft'
                  CHECK (status IN ('draft', 'active', 'archived')),
  steps           JSONB NOT NULL DEFAULT '[]',
  created_by      UUID NOT NULL REFERENCES users(id),
  published_at    TIMESTAMPTZ,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (crop_type_id, version)
);
```

#### `growth_stages`

```sql
CREATE TABLE growth_stages (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crop_type_id            UUID NOT NULL REFERENCES crop_types(id),
  code                    VARCHAR(30) NOT NULL,
  name                    JSONB NOT NULL,
  sequence_order          INTEGER NOT NULL,
  typical_duration_days   INTEGER,
  reference_photo_url     VARCHAR(500),
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (crop_type_id, sequence_order)
);
```

#### `schedule_rules`

```sql
CREATE TABLE schedule_rules (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crop_type_id            UUID NOT NULL REFERENCES crop_types(id),
  frequency_days          INTEGER NOT NULL,
  trigger                 VARCHAR(20) NOT NULL DEFAULT 'calendar'
                          CHECK (trigger IN ('calendar', 'growth_stage', 'manual')),
  overdue_threshold_days  INTEGER NOT NULL DEFAULT 7,
  status                  VARCHAR(20) NOT NULL DEFAULT 'active'
                          CHECK (status IN ('active', 'inactive')),
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `commodities`

```sql
CREATE TABLE commodities (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code        VARCHAR(20) UNIQUE NOT NULL,
  name        JSONB NOT NULL,
  unit        VARCHAR(20) NOT NULL
              CHECK (unit IN ('tonne', 'kg', 'bushel', 'litre')),
  status      VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE commodity_crop_types (
  commodity_id    UUID NOT NULL REFERENCES commodities(id),
  crop_type_id    UUID NOT NULL REFERENCES crop_types(id),
  PRIMARY KEY (commodity_id, crop_type_id)
);
```

#### `help_content`

```sql
CREATE TABLE help_content (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crop_type_id    UUID REFERENCES crop_types(id),    -- null = all crops
  title           JSONB NOT NULL,
  type            VARCHAR(20) NOT NULL
                  CHECK (type IN ('video', 'pdf', 'article')),
  url             VARCHAR(500) NOT NULL,
  target_role     VARCHAR(20) NOT NULL DEFAULT 'all'
                  CHECK (target_role IN ('assistant', 'admin', 'all')),
  sort_order      INTEGER NOT NULL DEFAULT 0,
  status          VARCHAR(20) NOT NULL DEFAULT 'active',
  created_by      UUID NOT NULL REFERENCES users(id),
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `regions`

```sql
CREATE TABLE regions (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name                    VARCHAR(100) NOT NULL,
  code                    VARCHAR(20) UNIQUE NOT NULL,
  parent_region_id        UUID REFERENCES regions(id),
  level                   VARCHAR(20) NOT NULL
                          CHECK (level IN ('country', 'state', 'district', 'zone')),
  boundary_coordinates    JSONB,                      -- GeoJSON polygon
  status                  VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

### 1.3 Organisation Tables

#### `users`

```sql
CREATE TABLE users (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sso_id                VARCHAR(255) UNIQUE NOT NULL,
  email                 VARCHAR(255) UNIQUE NOT NULL,
  name                  VARCHAR(255) NOT NULL,
  role                  VARCHAR(20) NOT NULL
                        CHECK (role IN ('super_admin', 'admin', 'field_assistant')),
  language_preference   VARCHAR(10) NOT NULL DEFAULT 'en',
  assigned_region_id    UUID REFERENCES regions(id),
  status                VARCHAR(20) NOT NULL DEFAULT 'pending'
                        CHECK (status IN ('pending', 'active', 'inactive')),
  last_login_at         TIMESTAMPTZ,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `farmers`

```sql
CREATE TABLE farmers (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name        VARCHAR(255) NOT NULL,
  phone       VARCHAR(30),
  national_id VARCHAR(50),
  region_id   UUID NOT NULL REFERENCES regions(id),
  status      VARCHAR(20) NOT NULL DEFAULT 'active',
  created_by  UUID NOT NULL REFERENCES users(id),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `farms`

```sql
CREATE TABLE farms (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name                  VARCHAR(255) NOT NULL,
  farmer_id             UUID NOT NULL REFERENCES farmers(id),
  region_id             UUID NOT NULL REFERENCES regions(id),
  crop_type_id          UUID NOT NULL REFERENCES crop_types(id),
  tracking_level        VARCHAR(10) NOT NULL
                        CHECK (tracking_level IN ('field', 'plant')),
  boundary_polygon      JSONB,                        -- GeoJSON polygon
  gps_latitude          DECIMAL(10, 8),
  gps_longitude         DECIMAL(11, 8),
  total_area_hectares   DECIMAL(10, 2),
  assigned_agent_id     UUID REFERENCES users(id),
  registered_by         UUID NOT NULL REFERENCES users(id),
  status                VARCHAR(20) NOT NULL DEFAULT 'pending_approval'
                        CHECK (status IN ('pending_approval', 'active', 'inactive', 'rejected')),
  rejection_reason      TEXT,
  approved_by           UUID REFERENCES users(id),
  approved_at           TIMESTAMPTZ,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `plants`

```sql
CREATE TABLE plants (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plant_code      VARCHAR(50) NOT NULL,               -- e.g. A-042
  farm_id         UUID NOT NULL REFERENCES farms(id),
  gps_latitude    DECIMAL(10, 8) NOT NULL,
  gps_longitude   DECIMAL(11, 8) NOT NULL,
  planting_date   DATE,
  notes           TEXT,
  registered_by   UUID NOT NULL REFERENCES users(id),
  status          VARCHAR(20) NOT NULL DEFAULT 'pending_approval'
                  CHECK (status IN ('pending_approval', 'active', 'inactive', 'rejected')),
  rejection_reason TEXT,
  approved_by     UUID REFERENCES users(id),
  approved_at     TIMESTAMPTZ,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (farm_id, plant_code)
);
```

#### `seasons`

```sql
CREATE TABLE seasons (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  farm_id                 UUID NOT NULL REFERENCES farms(id),
  season_number           INTEGER NOT NULL,
  planted_date            DATE NOT NULL,
  expected_harvest_date   DATE,
  actual_harvest_date     DATE,
  status                  VARCHAR(20) NOT NULL DEFAULT 'active'
                          CHECK (status IN ('active', 'harvested', 'failed')),
  created_by              UUID NOT NULL REFERENCES users(id),
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (farm_id, season_number)
);
```

---

### 1.4 Operational Tables

#### `visits`

```sql
CREATE TABLE visits (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id             UUID UNIQUE NOT NULL,         -- mobile-generated ID for dedup
  subject_type          VARCHAR(10) NOT NULL
                        CHECK (subject_type IN ('farm', 'plant')),
  subject_id            UUID NOT NULL,                -- farm_id or plant_id
  season_id             UUID REFERENCES seasons(id),  -- for field-level crops
  template_id           UUID NOT NULL REFERENCES visit_templates(id),
  template_version      INTEGER NOT NULL,
  agent_id              UUID NOT NULL REFERENCES users(id),
  gps_latitude          DECIMAL(10, 8),
  gps_longitude         DECIMAL(11, 8),
  gps_accuracy_meters   DECIMAL(6, 2),
  visit_data            JSONB NOT NULL DEFAULT '{}',  -- dynamic step responses
  notes                 TEXT,
  status                VARCHAR(20) NOT NULL DEFAULT 'submitted'
                        CHECK (status IN ('submitted', 'synced', 'analysed', 'error')),
  visited_at            TIMESTAMPTZ NOT NULL,
  synced_at             TIMESTAMPTZ,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_visits_subject ON visits(subject_type, subject_id);
CREATE INDEX idx_visits_agent ON visits(agent_id);
CREATE INDEX idx_visits_visited_at ON visits(visited_at DESC);
```

#### `visit_photos`

```sql
CREATE TABLE visit_photos (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  visit_id        UUID NOT NULL REFERENCES visits(id),
  step_id         VARCHAR(50),                        -- which template step
  storage_path    VARCHAR(500) NOT NULL,              -- Cloud Storage path
  file_size_bytes INTEGER,
  upload_status   VARCHAR(20) NOT NULL DEFAULT 'pending'
                  CHECK (upload_status IN ('pending', 'uploaded', 'failed')),
  uploaded_at     TIMESTAMPTZ,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `visit_analyses`

```sql
CREATE TABLE visit_analyses (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  visit_id              UUID NOT NULL REFERENCES visits(id),
  ai_request_id         VARCHAR(255),                 -- AI API reference
  crop_health_score     DECIMAL(5, 2),                -- 0.00 to 100.00
  predicted_yield_kg    DECIMAL(10, 2),
  growth_stage_code     VARCHAR(30),
  anomalies             JSONB DEFAULT '[]',
  raw_response          JSONB,                        -- full AI API response
  status                VARCHAR(20) NOT NULL DEFAULT 'pending'
                        CHECK (status IN ('pending', 'processing', 'complete', 'failed')),
  retry_count           INTEGER NOT NULL DEFAULT 0,
  analysed_at           TIMESTAMPTZ,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `scheduled_visits`

```sql
CREATE TABLE scheduled_visits (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  subject_type    VARCHAR(10) NOT NULL
                  CHECK (subject_type IN ('farm', 'plant')),
  subject_id      UUID NOT NULL,
  agent_id        UUID NOT NULL REFERENCES users(id),
  due_date        DATE NOT NULL,
  status          VARCHAR(20) NOT NULL DEFAULT 'upcoming'
                  CHECK (status IN ('upcoming', 'overdue', 'completed', 'cancelled')),
  completed_by    UUID REFERENCES visits(id),
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### `price_predictions`

```sql
CREATE TABLE price_predictions (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  commodity_id      UUID NOT NULL REFERENCES commodities(id),
  region_id         UUID REFERENCES regions(id),
  predicted_price   DECIMAL(12, 4) NOT NULL,
  price_unit        VARCHAR(20) NOT NULL,
  confidence        DECIMAL(5, 2),                    -- 0.00 to 100.00
  prediction_date   DATE NOT NULL,
  forecast_period   VARCHAR(20),                      -- e.g. 'weekly', 'monthly'
  contributing_data JSONB,                            -- factors used
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

### 1.5 Entity Relationship Diagram

```
regions ──────────────────────────────────────────────────────┐
  └── farmers ────────────────────────────────────────────┐   │
  └── users (assigned_region) ─────────────────────────┐  │   │
                                                        │  │   │
crop_types ──────────────────────────────────────────┐  │  │   │
  └── visit_templates                                │  │  │   │
  └── growth_stages                                  │  │  │   │
  └── schedule_rules                                 │  │  │   │
  └── commodity_crop_types ──── commodities          │  │  │   │
                                                     │  │  │   │
farms ─────────────── crop_type_id ──────────────────┘  │  │   │
  │   ─────────────── farmer_id ───────────────────────┘  │   │
  │   ─────────────── region_id ───────────────────────────┘   │
  │   ─────────────── assigned_agent_id ────────────────────────┘
  │
  ├── plants
  │     └── visits (subject_type='plant')
  │           ├── visit_photos
  │           └── visit_analyses
  │
  ├── seasons
  │
  └── visits (subject_type='farm')
        ├── visit_photos
        └── visit_analyses

scheduled_visits ─── subject_id → farm or plant
                  ─── agent_id → users
                  ─── completed_by → visits

price_predictions ─── commodity_id → commodities
                   ─── region_id → regions
```

---

## 2. Client-Side Schema (WatermelonDB — Mobile SQLite)

The mobile schema mirrors a subset of the server schema. It stores only what the field assistant needs locally for offline operation.

### 2.1 Conventions

- All records have a `server_id` (server UUID) and a local WatermelonDB `id`
- `sync_status`: `synced` | `pending_upload` | `pending_delete`
- Master data is downloaded on login and refreshed periodically
- New visits are created locally first with `sync_status: 'pending_upload'`

### 2.2 Local Tables

#### `crop_types` (local read-only cache)

```javascript
tableSchema({
  name: 'crop_types',
  columns: [
    { name: 'server_id', type: 'string', isIndexed: true },
    { name: 'code', type: 'string' },
    { name: 'name_json', type: 'string' },        // JSON stringified multilingual
    { name: 'tracking_level', type: 'string' },
    { name: 'is_seasonal', type: 'boolean' },
    { name: 'icon', type: 'string', isOptional: true },
    { name: 'status', type: 'string' },
    { name: 'updated_at', type: 'number' },        // epoch ms
  ]
})
```

#### `visit_templates` (local read-only cache)

```javascript
tableSchema({
  name: 'visit_templates',
  columns: [
    { name: 'server_id', type: 'string', isIndexed: true },
    { name: 'crop_type_id', type: 'string', isIndexed: true },
    { name: 'name_json', type: 'string' },
    { name: 'version', type: 'number' },
    { name: 'status', type: 'string' },
    { name: 'steps_json', type: 'string' },        // JSON stringified steps array
    { name: 'updated_at', type: 'number' },
  ]
})
```

#### `farms` (local cache — assigned farms only)

```javascript
tableSchema({
  name: 'farms',
  columns: [
    { name: 'server_id', type: 'string', isIndexed: true },
    { name: 'name', type: 'string' },
    { name: 'crop_type_id', type: 'string', isIndexed: true },
    { name: 'tracking_level', type: 'string' },
    { name: 'gps_latitude', type: 'number' },
    { name: 'gps_longitude', type: 'number' },
    { name: 'boundary_polygon_json', type: 'string', isOptional: true },
    { name: 'farmer_name', type: 'string' },
    { name: 'region_name', type: 'string' },
    { name: 'status', type: 'string' },
    { name: 'updated_at', type: 'number' },
  ]
})
```

#### `plants` (local cache)

```javascript
tableSchema({
  name: 'plants',
  columns: [
    { name: 'server_id', type: 'string', isIndexed: true },
    { name: 'farm_id', type: 'string', isIndexed: true },
    { name: 'plant_code', type: 'string' },
    { name: 'gps_latitude', type: 'number' },
    { name: 'gps_longitude', type: 'number' },
    { name: 'planting_date', type: 'string', isOptional: true },
    { name: 'status', type: 'string' },
    { name: 'updated_at', type: 'number' },
  ]
})
```

#### `visits` (local write — pending upload)

```javascript
tableSchema({
  name: 'visits',
  columns: [
    { name: 'client_id', type: 'string' },          // UUID generated on device
    { name: 'server_id', type: 'string', isOptional: true }, // set after sync
    { name: 'subject_type', type: 'string' },        // 'farm' | 'plant'
    { name: 'subject_server_id', type: 'string', isIndexed: true },
    { name: 'template_server_id', type: 'string' },
    { name: 'template_version', type: 'number' },
    { name: 'gps_latitude', type: 'number', isOptional: true },
    { name: 'gps_longitude', type: 'number', isOptional: true },
    { name: 'visit_data_json', type: 'string' },     // JSON stringified step responses
    { name: 'notes', type: 'string', isOptional: true },
    { name: 'visited_at', type: 'number' },          // epoch ms
    { name: 'sync_status', type: 'string' },         // 'pending_upload' | 'synced' | 'error'
    { name: 'sync_error', type: 'string', isOptional: true },
    { name: 'updated_at', type: 'number' },
  ]
})
```

#### `visit_photos` (local write — pending upload)

```javascript
tableSchema({
  name: 'visit_photos',
  columns: [
    { name: 'visit_client_id', type: 'string', isIndexed: true },
    { name: 'server_id', type: 'string', isOptional: true },
    { name: 'step_id', type: 'string', isOptional: true },
    { name: 'local_path', type: 'string' },          // local file path on device
    { name: 'file_size_bytes', type: 'number', isOptional: true },
    { name: 'upload_status', type: 'string' },       // 'pending' | 'uploaded' | 'failed'
    { name: 'storage_path', type: 'string', isOptional: true }, // set after upload
    { name: 'updated_at', type: 'number' },
  ]
})
```

#### `pending_registrations` (local write)

```javascript
tableSchema({
  name: 'pending_registrations',
  columns: [
    { name: 'client_id', type: 'string' },
    { name: 'server_id', type: 'string', isOptional: true },
    { name: 'type', type: 'string' },                // 'farm' | 'plant'
    { name: 'data_json', type: 'string' },           // all registration fields
    { name: 'photo_paths_json', type: 'string' },    // local photo paths
    { name: 'status', type: 'string' },              // 'pending_upload' | 'submitted' | 'approved' | 'rejected'
    { name: 'rejection_reason', type: 'string', isOptional: true },
    { name: 'sync_status', type: 'string' },
    { name: 'updated_at', type: 'number' },
  ]
})
```

---

## 3. Indexes

### Server-Side Performance Indexes

```sql
-- Farms nearby query (GPS-based)
CREATE INDEX idx_farms_gps ON farms(gps_latitude, gps_longitude)
  WHERE status = 'active';

-- Plants nearby query
CREATE INDEX idx_plants_gps ON plants(gps_latitude, gps_longitude)
  WHERE status = 'active';

-- Visit history per subject
CREATE INDEX idx_visits_subject_date ON visits(subject_type, subject_id, visited_at DESC);

-- Scheduled visits by agent and due date
CREATE INDEX idx_scheduled_agent_due ON scheduled_visits(agent_id, due_date)
  WHERE status IN ('upcoming', 'overdue');

-- Price predictions by commodity and date
CREATE INDEX idx_predictions_commodity_date ON price_predictions(commodity_id, prediction_date DESC);

-- Pending approvals
CREATE INDEX idx_farms_pending ON farms(status) WHERE status = 'pending_approval';
CREATE INDEX idx_plants_pending ON plants(status) WHERE status = 'pending_approval';
```

---

## 4. Data Retention Policy

| Table | Retention | Notes |
|---|---|---|
| visits | Indefinite | Core operational record |
| visit_photos | 5 years | Compressed after 1 year |
| visit_analyses | Indefinite | AI results are business critical |
| price_predictions | Indefinite | Historical data for model training |
| scheduled_visits | 2 years | Completed/cancelled |
| sync logs | 90 days | Debug only |

---

*AgriField — Commodity Intelligence Platform | Confidential — Internal Use Only*